<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>IDCM</title>

    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="./css/preloader.css">
    <link rel="stylesheet" href="./css/styleRack1.css">

    <!-- <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> -->
    <script type="text/javascript" src="https://www.chartjs.org/dist/2.8.0/Chart.min.js"></script>
</head>

<body>

    <div class="sidebar">
        <div class="rowImg">

            <div class="alignTitles">
                <h1>IDCM</h1>
                <h4>Lucas Bispo</h4>
                <h4>lucas@gmail.com</h4>
            </div>
            <div class="rowTitle">
                <img src="assets/iconFoto.svg" width="80" alt="">
            </div>
        </div>
        <h1 class="h1Admin">Admin</h1>
        <div class="alignTitles">
            <h1>Racks</h1>
            <div class="rowRacks">
                <div class="rack" style="background-color: #0099FF;">
                    <h1>1</h1>
                </div>
                <div class="rack" onclick="window.location.href=`rack2.html`">
                    <h1>2</h1>
                </div>
            </div>

            <div class="rowRacks">
                <div class="rack" onclick="window.location.href=`rack3.html`">
                    <h1>3</h1>
                </div>
                <div class="rack" onclick="window.location.href=`rack4.html`">
                    <h1>4</h1>
                </div>
            </div>
        </div>

        <div class="divButton">
            <button class="buttonSidebarConfig" onclick="screenConfig()">
                <img src="assets/iconConfig2.svg" alt="">
                Configurações
            </button>
        </div>

        <div class="divButton">
            <button class="buttonSidebarConfig" onclick="window.location.href=`dashboard.html`">
                <img src="assets/iconHomeDash.svg" alt="">
                Home
            </button>
        </div>
    </div>


    <div class="main">
        <h1>Rack1</h1>

        <div class="cardDashboard">
            <div class="containerGrafico">
                <div class="titulo1">
                    <h1>Temperatura Atual</h1>
                </div>
                <div class="grafico1">
                    <canvas id="graficoDados1" width="100" height="38"></canvas>
                </div>
            </div>
        </div>
        <div class="cardDashboard">
            <div class="containerGrafico2">
                <div class="titulo1">
                    <h1>Rank Media de Temperatura e Umidade Atual</h1>
                </div>
                <div class="grafico1">
                    <canvas id="myChart2" width="100" height="38"></canvas>
                </div>
            </div>

</body>

</html>

<script>
    function screenConfig() {
        window.location.href = `userConfig.html`
    }
    function screenLogin() {
        sessionStorage.clear()
        window.location.href = `login.html`
    }

</script>
<!-- <script>
    const labelsHorario = [
        '10h20',
        '10h40',
        '11h',
        '11h20',

    ];
    const labelsMedia = [
        'Media'

    ];


    const data = {
        labels: labelsHorario,
        datasets: [{
            label: 'Temperatura',
            backgroundColor: 'rgb(255, 99, 132)',
            borderColor: 'rgb(255, 99, 132)',
            data: [0, 18, 25, 27, 15, 23, 17],
        },
        {
            label: 'Umidade',
            backgroundColor: 'rgb(0, 0, 255)',
            borderColor: 'rgb(0, 0, 255)',
            data: [10, 10, 13, 15, 18, 18],
        }
        ]
    }


    const data2 = {
        labels: labelsMedia,
        datasets: [{
            label: 'Media Temperatura',
            backgroundColor: 'rgb(255, 99, 132)',
            borderColor: 'rgb(255, 99, 132)',
            data: [25],
        },
        {
            label: 'Media Umidade',
            backgroundColor: 'rgb(0, 0, 255)',
            borderColor: 'rgb(0, 0, 255)',
            data: [18],
        }
        ]
    }


    const config = {
        type: 'line',
        data: data,
        options: {}
    };


    const config2 = {
        type: 'bar',
        data: data2,
        options: {
            indexAxis: 'y',
        }
    };
</script>

<script>
    const myChart = new Chart(
        document.getElementById('myChart'),
        config
    );

    const myChart2 = new Chart(
        document.getElementById('myChart2'),
        config2
    );
</script> -->




<script>
    var Rack1 = 1;

    let proximaAtualizacao;

    window.onload = obterDadosGrafico(1);



    function obterDadosGrafico(idEmpresa,idRack) {
        console.log("cheguei aqui");

        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        fetch(`/medidas/realtime`, {
            cache: 'no-store',
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                MyEmpresa: sessionStorage.fk_empresa,
                MyRack: Rack1
            })
        }).then((response) => {
            if (response.ok) {
                response.json().then(function(resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    // resposta.reverse();
                    console.log("aaaaaa"+ resposta[0]);
                    plotarGrafico(resposta);  
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function plotarGrafico(idEmpresa,idRack, resposta) {
        console.log('iniciando plotagem do gráfico...');

        var dados = {
            labels: [],
            datasets: [
                {
                    yAxisID: 'y-umidade',
                    label: 'umidade',
                    borderColor: '#32B9CD',
                    backgroundColor: '#32b9cd8f',
                    fill: true,
                    data: []
                },
                {
                    yAxisID: 'y-temperatura',
                    label: 'temperatura',
                    borderColor: '#FF0000',
                    backgroundColor: '#FF0000',
                    fill: true,
                    data: []
                }
            ]
        };
        for (contador = 0; contador < resposta.length; contador++) {
            var registro = resposta[contador];
            dados.labels.push(registro.data_time);
            dados.datasets[0].data.push(registro.temperatura);
            dados.datasets[1].data.push(registro.umidade);
        }

        console.log(JSON.stringify(dados));

        var ctx = graficoDados1.getContext('2d');
        window.grafico_linha = Chart.Line(ctx, {
            data: dados,
            options: {
                responsive: true,
                animation: { duration: 500 },
                hoverMode: 'index',
                stacked: false,
                title: {
                    display: false,
                    text: 'Dados capturados'
                },
                scales: {
                    yAxes: [{
                        type: 'linear',
                        display: true,
                        position: 'left',
                        id: 'y-temperatura',
                        ticks: {
                            beginAtZero: true,
                            max: 100,
                            min: 0
                        }
                    }, {
                        type: 'linear',
                        display: false,
                        position: 'right',
                        id: 'y-umidade',
                        ticks: {
                            beginAtZero: true,
                            max: 100,
                            min: 0
                        },

                        gridLines: {
                            drawOnChartArea: false,
                        },
                    }],
                }
            }
        });

        setTimeout(() => atualizarGrafico(idEmpresa,idRack, dados), 2000);
    }

    function atualizarGrafico(idEmpresa,idRack, dados) {

        fetch(`/medidas/tempo-real`, { cache: 'no-store' }).then((response) => {
            if (response.ok) {
                response.json().then((novoRegistro) => {

                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico: ${dados}`);

                    // tirando e colocando valores no gráfico
                    dados.labels.shift(); // apagar o primeiro
                    dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento

                    dados.datasets[0].data.shift();  // apagar o primeiro de umidade
                    dados.datasets[0].data.push(novoRegistro[0].umidade); // incluir uma nova medida de umidade

                    dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
                    dados.datasets[1].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura

                    window.grafico_linha.update();

                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(req, res, dados), 2000);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                proximaAtualizacao = setTimeout(() => atualizarGrafico(req, res, dados), 2000);
            }
        })
            .catch((error) => {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }
</script>